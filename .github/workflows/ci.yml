name: Continuous Integration
on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

env:
  MAKEFLAGS: ${{ (github.repository == 'numworks/epsilon-internal') && '-j32' || '-j2' }}

jobs:
  linux:
    runs-on: ${{ (github.repository == 'numworks/epsilon-internal') && 'self-hosted' || 'ubuntu-latest' }}
    steps:
      - uses: numworks/setup-llvm@latest
      - uses: actions/checkout@v3
      - run: build/setup.sh --only-simulator
      - run: make PLATFORM=simulator ASAN=1 TIDY=1 ASSERTIONS=1 epsilon.bin test.bin
      - run: output/release/simulator/linux/test.bin --headless --limit-stack-usage
      - uses: actions/upload-artifact@v3
        if: ${{ (github.repository != 'numworks/epsilon-internal') }}
        with:
          name: epsilon-linux.bin
          path: output/release/simulator/linux/epsilon.bin
  windows:
    runs-on: windows-latest
    if: ${{ (github.repository != 'numworks/epsilon-internal') }}
    defaults:
       run:
         shell: msys2 {0}
    steps:
      - uses: msys2/setup-msys2@v2
      - uses: actions/checkout@v3
      - run: build/setup.sh --only-simulator
      - run: make PLATFORM=simulator ASSERTIONS=1 epsilon.exe test.exe
      - run: cmd /c output\release\simulator\windows\test.exe --headless --limit-stack-usage
      - uses: actions/upload-artifact@v3
        with:
          name: epsilon-windows.exe
          path: output/release/simulator/windows/epsilon.exe
